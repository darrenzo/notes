# web-render

## 步骤

- 输入地址
- 浏览器查找域名的 IP 地址 (DNS解析)
- 浏览器向 web 服务器发送一个 HTTP 请求
- 服务器的永久重定向响应
- 浏览器跟踪重定向地址
- 服务器处理请求
- 服务器返回一个 HTTP 响应
- 浏览器显示 HTML
- 浏览器发送请求获取嵌入在 HTML 中的资源（如图片、音频、视频、CSS、JS等等）

## 输入地址

- 输入地址时，浏览器其实就已经在智能的匹配可能的 url 了，它会从历史记录、书签等地方，找到已经输入的字符串可能对应的 url，然后给出智能提示，让你可以补全url地址, chrome甚至会直接从缓存中把网页展示出来，就是说，你还没有按下 enter，页面就出来了

## 浏览器查找域名的 IP 地址

- 参照[DNS.md](/base/DNS.md)

## 浏览器向 web 服务器发送一个 HTTP 请求

- 参照[http.md](/base/http.md)的http请求

## 服务器的永久重定向响应

- 301重定向详[http.md](/base/http.md)状态码部分
- 服务器给浏览器响应一个301永久重定向响应，这样浏览器就会访问`http://www.google.com/` 而非`http://google.com/`
- 使用重定向的原因：
  - 搜索引擎排名
    - 如果一个页面有两个地址，就像`http://www.yy.com/和http://yy.com/`，搜索引擎会认为它们是两个网站，结果造成每个搜索链接都减少从而降低排名。而搜索引擎知道301永久重定向是什么意思，这样就会把访问带www的和不带www的地址归到同一个网站排名下
  - 用不同的地址会造成缓存友好性变差，当一个页面有好几个名字时，它可能会在缓存里出现好几次

## 浏览器跟踪重定向地址

- 当浏览器获取最终的地址 `http://www.google.com/`，它会发送另一个http请求

## 服务器处理请求

- 参照[http.md](/base/http.md)的http请求

## 服务器返回一个 HTTP 响应

- 参照[http.md](/base/http.md)的http响应

## 浏览器显示 HTML

- 在浏览器没有完整接受全部HTML文档时，它就已经开始显示这个页面了
- 不同浏览器可能解析的过程不太一样，此处为webkit的渲染过程
- 解析html以构建dom树 -> 解析CSS文件以构建render树 -> 布局render树 -> 绘制render树
  - 整个DOM树的构建过程： 字节 -> 字符 -> 令牌 -> 节点对象 -> 对象模型
  - 关键渲染路径：首先浏览器要先对服务器发送请求获得HTML文件，得到HTML文件后开始构建DOM树，在遇见`<link>`标签时浏览器需要向服务器再次发出请求来获得CSS文件，然后则是继续构建DOM树和CSSOM树，浏览器合并出渲染树，根据渲染树进行布局计算，执行绘制操作，页面渲染完成

![webkit-render](/img/webkit-render.png)

- 浏览器在解析html文件时，会**自上而下**加载，并在加载过程中进行解析渲染
  - 在解析过程中，如果遇到请求外部资源时，如图片、外链的CSS、iconfont等，请求过程是异步的，并不会影响html文档进行加载
- reflow(回流)和repain(重绘)
  - DOM节点中的各个元素都是以盒模型的形式存在，这些都需要浏览器去计算其位置和大小等，这个过程称为relow
  - 当盒模型的位置,大小以及其他属性，如颜色,字体,等确定下来之后，浏览器便开始绘制内容，这个过程称为repain
  - 页面在首次加载时必然会经历reflow和repain，这两个过程是非常耗性能的（回流消耗的性能是重绘的几倍）
- 当文档加载过程中遇到js文件，html文档会挂起渲染（加载解析渲染同步）的线程，不仅要等待文档中js文件加载完毕，还要等待解析执行完毕，才可以恢复html文档的渲染线程
  - 因为JS有可能会修改DOM，在JS执行完成前，后续所有资源的下载可能是没有必要的，这是js阻塞后续资源下载的根本原因，所以js是放在html文档末尾的

## 浏览器发送请求获取嵌入在 HTML 中的资源（如图片、音频、视频、CSS、JS等等）

- 在浏览器显示HTML时，它会注意到需要获取其他地址内容的标签，浏览器会发送一个获取请求来重新获得这些文件
- 这些地址都要经历一个和HTML读取类似的过程。所以浏览器会在DNS中查找这些域名，发送请求，重定向等等
- 静态文件会允许浏览器对其进行缓存
- 有的文件可能会不需要与服务器通讯，而从缓存中直接读取，或者可以放到CDN中
